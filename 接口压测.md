# Spring Boot API 压测增强版技能（精简优化版）
name: "spring-boot-api-pressure-test-enhanced"
description: "Spring Boot API全闭环压测：工具环境一键校验配置→生成可执行JMeter脚本+测试数据→压测+Arthas全指标监控→瓶颈分析→精简版HTML报告，输出所有脚本/命令/模板均可直接使用，流程精简防关键信息遗忘，数据/脚本严格适配接口无报错。"

## 核心定位&适用场景
**适配环境**：Java Spring Boot项目（支持@Lazy懒加载，降低指标失真）、RESTful API（秒杀/库存/高并发查询/数据创建类为主）、单机/集群压测环境

## 核心执行规则（融合历史问题，必须严格遵循）
1. **环境前置校验**：未通过`jmeter -v`/`arthas`全局命令校验前，禁止后续所有步骤，确保工具可正常调用；
2. **数据绝对可用**：生成的测试数据（真实获取/模拟生成）必须严格匹配接口入参约束、数据依赖，杜绝因数据问题导致的100%错误率；
3. **分析聚焦接口**：压测分析/瓶颈定位**仅体现接口本身性能问题**，排除JMeter脚本编写、工具使用等外部问题，不将外部错误纳入分析；
4. **信息后置采集**：关键环境/需求信息延后至「脚本生成前」统一采集，通过**选项列表/固定问题**唤起提问，避免长流程遗忘；
5. **结果可落地**：所有脚本、命令、配置、优化建议均为**可直接复制执行**，瓶颈分析必须有Arthas监控数据支撑，无主观臆断；
6. **报告精简聚焦**：HTML报告仅保留**核心压测数据+分优先级优化建议**，剔除冗余模块，直观展示接口性能核心信息。

## 一、核心流程（精简版，防信息遗忘）
### 整体流程（共5步，后置信息采集，步骤无冗余）
`1. 工具环境命令式校验+一键配置` → `2. 生成可执行JMeter基础脚本` → `3. 统一采集关键信息（选项列表提问）` → `4. 压测+Arthas同步监控` → `5. 生成精简版HTML压测报告`
### 流程优化说明
- 把**压测机性能、目标QPS、接口核心信息**等关键采集工作，从流程开头移至「JMeter基础脚本生成后」，此时聚焦信息采集，避免长流程遗忘；
- 所有信息采集均通过**客户端选项列表/固定问题**唤起提问，不直接输出大段文本，适配agent提问功能；
- 剔除冗余分析步骤，仅保留「接口核心数据依赖」分析，确保测试数据可用，其余非核心环节融入对应步骤。

## 二、核心能力1：JMeter/Arthas工具环境命令式校验+一键配置（前置必做）
### 校验规则
**仅通过终端命令校验**，未安装则输出**分系统（Linux/Windows/Mac）一键配置命令**，确保工具可**全局命令行调用**，无手动复杂配置。
### 1. Arthas校验+一键配置
#### 命令校验（任意目录执行，输出版本/列出Java进程即成功）
```bash
# 核心校验
arthas -v
# 备用校验
java -jar /usr/local/arthas/arthas-boot.jar -v
```
#### 分系统一键配置（复制即执行，全局可用）
##### Linux/Mac
```bash
mkdir -p /usr/local/arthas && curl -O https://arthas.aliyun.com/arthas-boot.jar && mv arthas-boot.jar /usr/local/arthas/
echo 'alias arthas="java -jar /usr/local/arthas/arthas-boot.jar"' >> ~/.bashrc && source ~/.bashrc
```
##### Windows
1. 下载：https://arthas.aliyun.com/arthas-boot.jar → 保存至`C:\arthas\`
2. 新增`arthas.bat`在同目录：`@java -jar C:\arthas\arthas-boot.jar %*`
3. 配置环境变量：Path添加`%ARTHAS_HOME%`（ARTHAS_HOME=C:\arthas）
4. 校验：CMD任意目录执行`arthas`，列出Java进程即成功

### 2. JMeter校验+一键配置（含JDK前置校验）
#### 前置条件
JDK8/11/17已安装（`java -version`可输出版本，推荐JDK8）
#### 命令校验（任意目录执行，直接输出版本即成功）
```bash
jmeter -v
```
#### 分系统一键配置（复制即执行，全局可用）
##### Linux/Mac
```bash
wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.zip -P /opt && unzip /opt/apache-jmeter-5.6.3.zip -d /opt
echo 'export JMETER_HOME=/opt/apache-jmeter-5.6.3 && export PATH=$PATH:$JMETER_HOME/bin' >> /etc/profile && source /etc/profile
```
##### Windows
1. 下载：https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.zip → 解压至`D:\apache-jmeter-5.6.3`（无空格/中文）
2. 配置环境变量：新增`JMETER_HOME=D:\apache-jmeter-5.6.3`，Path添加`%JMETER_HOME%\bin`
3. 校验：CMD执行`jmeter -v`输出版本即成功
#### JMeter核心压测命令（无GUI，直接使用）
```bash
# 执行脚本+生成结果+直接输出HTML报告（一步到位）
jmeter -n -t 压测脚本.jmx -l 测试结果.jtl -e -o 压测报告/
```

## 三、核心能力2：生成可执行JMeter基础脚本（通用版，无需提前填信息）
### 脚本核心特性（规避历史错误，确保可用）
- 集成**通用CSV参数化配置**，仅预留变量占位，后续采集信息后直接替换即可；
- 添加**精准响应断言**（仅校验接口本身字段，如200状态码、业务success字段），不因断言规则错误导致误判；
- 极简配置，仅保留核心模块（线程组/HTTP请求/断言/结果收集），无冗余组件，方便后续调整；
-纠错提醒：你曾经经常写错jemeter脚本导致无法启动。请严格生成好脚本
请基于以下极简JMeter模板，替换模板中的占位符为实际业务值，生成完整可运行的JMX脚本：
【极简模板】
<HTTPSamplerProxy>
  <stringProp name="HTTPSampler.protocol">${protocol}</stringProp>
  <stringProp name="HTTPSampler.domain">${ip}</stringProp>
  <stringProp name="HTTPSampler.method">${method}</stringProp>
  <stringProp name="HTTPSampler.path">${api_path}</stringProp>
  <stringProp name="HTTPSampler.body_data">${request_body}</stringProp>
</HTTPSamplerProxy>
【变量清单】
1. protocol：http/https  2. ip：接口IP  3. method：请求方式  4. api_path：接口路径  5. request_body：JSON请求体（含CSV变量）


## 四、核心能力3：关键信息统一采集（后置采集，选项列表提问，防遗忘）
### 采集时机
生成JMeter基础脚本后，**通过客户端选项列表/固定问题逐一提问**，统一采集所有关键信息，采集完成后自动替换脚本占位符、生成测试数据、定制压测计划。
### 采集内容（分4类，均为选项/简短回答，无大段文本）
#### 【第一类】接口核心信息（必选/简短输入，唤起提问：请选择/输入以下接口信息）
1. 接口请求协议：「1.HTTP 2.HTTPS」
2. 接口IP/域名：（输入框，例：192.168.1.100）
3. 接口端口：（输入框，例：8080）
4. 接口请求方式：「1.GET 2.POST 3.PUT 4.DELETE」
5. 接口路径：（输入框，例：/api/v1/seckill）
6. 接口请求头：（输入框，例：Content-Type:application/json;Token:xxx）
7. 接口请求体/入参：（输入框，例：{"userId":"${userId}","productId":"${productId}"}）
8. 接口核心校验字段：（输入框，例：success:true/200）

#### 【第二类】压测机硬件信息（必选，唤起提问：请选择压测机性能配置）
1. 压测机CPU核心数：「1.4核 2.8核 3.16核 4.其他（输入）」
2. 压测机内存：「1.8GB 2.16GB 3.32GB 4.其他（输入）」
3. 压测机操作系统：「1.Linux 2.Windows 3.Mac」

#### 【第三类】压测需求信息（必选，唤起提问：请选择/输入以下压测需求）
1. 目标基准QPS：（输入框，例：200；若无则自动预测）
2. 压测梯度数：「1.2梯度（基础+目标） 2.3梯度（基础+目标+极限）」
3. 单梯度压测总时长：「1.5分钟 2.7分钟 3.10分钟」

#### 【第四类】测试数据来源（必选，唤起提问：请选择测试数据生成方式）
1. 数据来源：「1.从测试环境获取真实数据 2.自动生成模拟数据」
2. 需生成/获取的测试数据量：（输入框，例：2000条）
3. 接口入参约束：（输入框，例：userId:1000-9999;productId:5000-5999）

### 采集后自动处理
1. 自动替换JMeter基础脚本中的所有占位符，生成**接口专属可执行脚本**；
2. 基于压测机性能+接口类型（自动判断），**科学预测QPS**（无目标QPS时），生成标准化压测计划；
3. 基于接口入参约束，生成**100%可用的CSV测试数据文件**（真实获取/模拟生成），杜绝数据错误导致的压测失败；
4. 生成**压测+监控同步执行命令**，一键启动，无需手动配置。

## 五、核心能力4：压测+Arthas全指标监控（同步执行，仅分析接口问题）
### 执行规则
1. 采集信息后，自动生成**一键执行命令**，压测与监控**同步启动**，无时间差，确保数据真实；
2. Arthas监控仅采集**与接口性能相关的核心指标**，日志按梯度保存，方便后续分析；
3. 瓶颈分析**仅聚焦接口本身**，排除JMeter脚本、工具使用等外部问题，不将外部错误纳入分析报告。
### 1. 一键同步执行命令（生成后直接复制执行，自动保存日志）
```bash
# 后台启动Arthas监控，仅采集接口相关指标，保存日志（按时间戳命名，防覆盖）
nohup bash -c "arthas dashboard -n 1000 > dashboard_$(date +%Y%m%d).log && thread -n 10 -i 2000 > thread_$(date +%Y%m%d).log && trace ${full_class}.${method} -j > trace_$(date +%Y%m%d).log && gc -i 1000 > gc_$(date +%Y%m%d).log && sql > sql_$(date +%Y%m%d).log" &
# 启动JMeter接口专属压测脚本，直接生成HTML报告
jmeter -n -t api_test.jmx -l api_result_$(date +%Y%m%d).jtl -e -o api_report_$(date +%Y%m%d)/
# 压测完成后自动停止Arthas，避免占用资源
ps -ef | grep arthas | grep -v grep | awk '{print $2}' | xargs kill -9
```
**说明**：`${full_class}.${method}`为采集信息后自动替换的**接口对应业务全类名+方法名**（例：com.seckill.service.SeckillService.doSeckill）。

### 2. Arthas核心监控指标（仅聚焦接口相关，无冗余）
| 监控维度 | Arthas命令 | 核心分析指标（仅关联接口性能） |
|----------|------------|--------------------------------|
| JVM监控  | `dashboard` | 接口执行时CPU/内存使用率、活跃线程数、接口平均RT |
| 线程分析 | `thread -n 10` | 接口业务方法相关的阻塞/忙线程、死锁线程 |
| 方法追踪 | `trace 全类名 方法名` | 接口核心方法总耗时、子方法耗时、慢方法定位 |
| GC监控   | `gc -i 1000` | 接口压测时YGC/FGC频率、耗时，是否导致接口停顿 |
| SQL监控  | `sql` | 接口关联的慢SQL（执行时间＞50ms）、执行次数 |

### 3. 瓶颈分析规则（融合历史问题，仅分析接口本身）
1. **有数据支撑**：每个瓶颈必须附Arthas监控日志片段/具体数据，无主观判断；
2. **聚焦接口问题**：仅分析**接口代码/业务逻辑/数据库/缓存/分布式锁**等接口本身的性能问题，排除工具、脚本等外部问题；
3. **分优先级排序**：按「高（立即解决）→中（上线前解决）→低（后续迭代）」排序，方便落地。
### 瓶颈分析输出示例（结构化，简洁明了）
```markdown
# 接口性能瓶颈分析清单（仅聚焦接口本身）
## 高优先级（立即解决）
1. 【接口核心方法慢】trace日志显示doSeckill方法平均耗时200ms，其中库存扣减SQL占150ms，为核心耗时点；
2. 【分布式锁竞争】thread日志显示30+线程阻塞在接口的RedissonLock.tryLock()方法，导致接口RT飙升。

## 中优先级（上线前解决）
1. 【YGC频繁】gc日志显示压测时YGC每3秒1次，导致接口RT波动达80ms，影响稳定性。

## 低优先级（后续迭代）
1. 【本地缓存未使用】接口频繁查询商品基础信息，未做本地缓存，增加DB访问压力。
```

## 六、核心能力5：精简版HTML压测报告（压缩文本，仅保留数据+优化建议）
### 报告核心特性
1. **极致压缩**：剔除所有冗余模块（如报告概览、附录、多余说明），仅保留**核心压测数据+分优先级优化建议**，文本量大幅减少；
2. **数据直观**：以**表格+极简图表**展示压测核心指标，无冗余可视化；
3. **建议落地**：优化建议均为**可直接复制执行的代码/配置**，按优先级排序，聚焦接口问题解决；
4. **无外部信息**：报告中不体现任何JMeter脚本、工具使用等外部问题，仅分析接口本身。

### 精简版HTML压测报告（可直接运行，压缩后版本）
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot API压测核心报告</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", sans-serif;}
        body {background: #f5f7fa; padding: 20px;}
        .container {max-width: 1000px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        .title {text-align: center; font-size: 20px; font-weight: 700; color: #2563eb; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #2563eb;}
        .mod-title {font-size: 16px; font-weight: 600; color: #2563eb; margin: 15px 0 10px 0; display: flex; align-items: center; gap: 6px;}
        .mod-title::before {content: ""; width: 4px; height: 16px; background: #2563eb; border-radius: 2px;}
        table {width: 100%; border-collapse: collapse; margin: 10px 0;}
        table th, td {padding: 10px; text-align: center; border: 1px solid #e2e8f0; font-size: 14px;}
        table th {background: #f8fafc; color: #1f2937;}
        .chart {width: 100%; height: 300px; margin: 10px 0; border: 1px solid #e2e8f0; border-radius: 4px;}
        .opt-card {background: #ecfdf5; border-left: 4px solid #10b981; padding: 12px; margin: 8px 0; border-radius: 4px;}
        .opt-card.high {border-left-color: #dc2626; background: #fef2f2;}
        .opt-card.mid {border-left-color: #f59e0b; background: #fffbeb;}
        .opt-title {font-weight: 600; margin-bottom: 5px;}
        .opt-code {background: #1f2937; color: #f9fafb; padding: 10px; border-radius: 4px; margin: 8px 0; font-size: 13px; overflow-x: auto; font-family: Consolas, monospace;}
    </style>
</head>
<body>
    <div class="container">
        <!-- 报告标题 -->
        <h1 class="title">Spring Boot API压测核心报告 - 接口：${api_path}</h1>

        <!-- 1. 核心压测数据（核心模块，无冗余） -->
        <div class="module">
            <h2 class="mod-title">一、核心压测指标数据</h2>
            <table>
                <tr>
                    <th>压测梯度</th>
                    <th>并发数</th>
                    <th>实际QPS</th>
                    <th>平均RT(ms)</th>
                    <th>P95(ms)</th>
                    <th>P99(ms)</th>
                    <th>成功率(%)</th>
                    <th>接口CPU使用率(%)</th>
                </tr>
                <tr><td>基础验证</td><td>${c1}</td><td>${q1}</td><td>${rt1}</td><td>${p95_1}</td><td>${p99_1}</td><td>${s1}</td><td>${cpu1}</td></tr>
                <tr><td>目标验证</td><td>${c2}</td><td>${q2}</td><td>${rt2}</td><td>${p95_2}</td><td>${p99_2}</td><td>${s2}</td><td>${cpu2}</td></tr>
                <tr><td>极限验证</td><td>${c3}</td><td>${q3}</td><td>${rt3}</td><td>${p95_3}</td><td>${p99_3}</td><td>${s3}</td><td>${cpu3}</td></tr>
            </table>
            <!-- 极简图表：QPS+P99趋势（核心指标可视化） -->
            <div class="chart" id="mainChart"></div>
        </div>

        <!-- 2. 分优先级优化建议（核心模块，可直接执行） -->
        <div class="module">
            <h2 class="mod-title">二、接口性能优化建议（可直接执行）</h2>
            <!-- 高优先级：立即解决 -->
            <div class="opt-card high">
                <div class="opt-title">【高优先级】立即解决 - 核心瓶颈（影响接口QPS/成功率）</div>
                <p>${opt_high_desc}</p>
                <div class="opt-code">${opt_high_code}</div>
            </div>
            <!-- 中优先级：上线前解决 -->
            <div class="opt-card mid">
                <div class="opt-title">【中优先级】上线前解决 - 稳定性优化（影响接口RT波动）</div>
                <p>${opt_mid_desc}</p>
                <div class="opt-code">${opt_mid_code}</div>
            </div>
            <!-- 低优先级：后续迭代 -->
            <div class="opt-card">
                <div class="opt-title">【低优先级】后续迭代 - 性能提升（进一步提升QPS）</div>
                <p>${opt_low_desc}</p>
                <div class="opt-code">${opt_low_code}</div>
            </div>
        </div>

        <!-- 3. 优化后预期效果（简洁表格） -->
        <div class="module">
            <h2 class="mod-title">三、优化后预期效果</h2>
            <table>
                <tr>
                    <th>核心指标</th>
                    <th>优化前（极限梯度）</th>
                    <th>优化后（极限梯度）</th>
                    <th>提升幅度</th>
                </tr>
                <tr><td>实际QPS</td><td>${old_qps}</td><td>${new_qps}</td><td>${up_qps}</td></tr>
                <tr><td>P99 RT(ms)</td><td>${old_p99}</td><td>${new_p99}</td><td>${up_p99}</td></tr>
                <tr><td>成功率(%)</td><td>${old_suc}</td><td>${new_suc}</td><td>${up_suc}</td></tr>
            </table>
        </div>
    </div>

    <!-- 极简ECharts图表：仅展示QPS+P99核心趋势 -->
    <script>
        var myChart = echarts.init(document.getElementById('mainChart'));
        var option = {
            title: {text: '各梯度QPS & P99 RT趋势', fontSize: 14},
            tooltip: {trigger: 'axis'},
            legend: {data: ['实际QPS', 'P99 RT(ms)'], top: 20},
            grid: {left: '3%', right: '4%', bottom: '3%', containLabel: true},
            xAxis: {type: 'category', data: ['基础验证', '目标验证', '极限验证']},
            yAxis: [
                {type: 'value', name: 'QPS', min: 0},
                {type: 'value', name: 'P99 RT(ms)', min: 0, position: 'right'}
            ],
            series: [
                {name: '实际QPS', type: 'bar', yAxisIndex: 0, data: [${q1}, ${q2}, ${q3}], color: '#10b981'},
                {name: 'P99 RT(ms)', type: 'line', yAxisIndex: 1, data: [${p99_1}, ${p99_2}, ${p99_3}], color: '#dc2626', lineWidth: 3}
            ]
        };
        myChart.setOption(option);
        window.addEventListener('resize', () => myChart.resize());
    </script>
</body>
</html>
```
### 报告使用说明
1. 采集压测数据后，仅需替换报告中的`${xxx}`占位符（如接口路径、压测指标、优化建议、代码），无需修改其他内容；
2. 直接保存为`api_pressure_report.html`，浏览器打开即可查看，支持分享/打印；
3. 图表为极简版，仅展示**QPS+P99**核心趋势，如需新增指标，仅需修改ECharts的`data`部分即可。