# 秒杀接口压测计划 - 目标QPS=100

## 📋 测试基础信息

### 用户需求
- **预期QPS**: 100
- **压测机器性能**: 4核8GB
- **业务指标要求**:
  - 超卖率 ≤ 0.1%
  - 库存一致性 = 100%
  - 订单成功率 ≥ 99.9%

### 目标接口
- **接口地址**: POST http://localhost:8080/api/v1/seckill/order
- **请求参数**: 
  - userId: Long (用户ID)
  - productCode: String (商品编码)
  - quantity: Integer (数量，默认1)

### 技术环境
- **Spring Boot应用**: 端口8080
- **数据库**: H2内存数据库
- **缓存**: Redis (当前降级到内存)
- **压测工具**: JMeter 5.6.3
- **监控工具**: Arthas 4.1.5

## 🚀 压测计划设计

### 并发梯度设计（基于4核8GB机器）

| 梯度 | 并发数 | 预期QPS | 持续时间 | 主要目标 | 业务验证重点 |
|------|--------|---------|----------|----------|-------------|
| 1 | 50 | 50 | 7分钟 | 基础性能验证 | 正常购买流程 |
| 2 | 100 | 100 | 7分钟 | **目标QPS验证** | 核心业务指标 |
| 3 | 120 | 110 | 7分钟 | 极限压力测试 | 系统稳定性 |

### 单个梯度时间分配
- **预热期**: 1分钟 (让JVM达到稳定状态)
- **正式压测**: 5分钟 (收集核心数据)
- **冷却期**: 1分钟 (让系统恢复正常)

### 业务指标监控重点
1. **超卖率监控**: 订单数量 vs 库存扣减
2. **库存一致性**: Redis库存 vs 数据库库存
3. **订单成功率**: 成功订单数 / 总请求数
4. **重复购买拦截**: 同用户重复购买拒绝率

## 🔧 测试数据设计

### 测试用户分配
- **梯度1**: 50个唯一用户ID (1001-1050)
- **梯度2**: 100个唯一用户ID (1051-1150) 
- **梯度3**: 120个唯一用户ID (1151-1270)

### 商品选择策略
基于之前的数据分析，主要选择以下商品进行压测：
- **IPHONE15PRO**: 库存48件，价格¥6,999
- **XIAOMI13ULTRA**: 库存78件，价格¥4,999
- **其他可秒杀商品**: 库存足够

### 测试场景覆盖
1. **正常购买流程** - 新用户+有库存商品
2. **重复购买拦截** - 同一用户重复购买
3. **库存边界测试** - 接近售罄的商品
4. **参数验证** - 非法参数处理
5. **并发一致性** - 相同商品多用户同时抢购

## 📊 数据收集计划

### JMeter指标收集
- **响应时间**: 平均值、P95、P99
- **吞吐量**: 每秒请求数
- **错误率**: 4xx/5xx错误统计
- **成功率**: 业务成功响应统计

### Arthas监控命令
- **基础监控**: dashboard、memory、thread
- **接口监控**: trace、monitor、watch
- **业务监控**: SQL执行、Redis操作

### 数据输出格式
- **JMeter结果**: .jtl文件 + HTML报告
- **Arthas日志**: 各种监控命令输出
- **业务指标**: 自定义统计脚本

## 🎯 预期结果

### 性能指标预期
| 梯度 | 预期QPS | 预期平均响应时间 | 预期P99响应时间 |
|------|---------|-----------------|----------------|
| 1 | 50 | <50ms | <150ms |
| 2 | 100 | <80ms | <200ms |
| 3 | 110 | <120ms | <300ms |

### 业务指标预期
- **超卖率**: < 0.1% (所有梯度)
- **库存一致性**: 100% (所有梯度)
- **订单成功率**: >99.9% (梯度1-2), >99.5% (梯度3)

## ⚠️ 风险控制

### 压测停止条件
1. **成功率低于95%** - 立即停止
2. **响应时间超过5秒** - 立即停止
3. **系统内存溢出** - 立即停止
4. **数据库连接池耗尽** - 立即停止

### 恢复策略
1. **每个梯度结束后等待2分钟** - 让JVM完全恢复
2. **观察内存使用率** - 确保GC完成
3. **检查数据库连接** - 确保连接池恢复

## 📈 执行时间表

| 时间段 | 操作 | 预计耗时 |
|--------|------|----------|
| 09:00-09:15 | JMeter脚本准备 + Arthas配置 | 15分钟 |
| 09:15-09:22 | **梯度1压测** (50并发) | 7分钟 |
| 09:22-09:29 | **梯度2压测** (100并发) | 7分钟 |
| 09:29-09:36 | **梯度3压测** (120并发) | 7分钟 |
| 09:36-09:50 | 数据分析和报告生成 | 14分钟 |

**总预计时间**: 50分钟